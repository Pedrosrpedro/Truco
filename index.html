<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truco P2P (Host/Cliente)</title>
    <!-- 1. Importando a biblioteca PeerJS de um CDN -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peer.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #0d47a1; color: white; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .placar { display: flex; justify-content: space-around; font-size: 24px; margin-bottom: 20px; }
        .mesa { background-color: #00695c; border: 5px solid #004d40; border-radius: 10px; padding: 20px; margin: 20px 0; min-height: 250px; display: flex; justify-content: space-around; align-items: center; }
        .area-cartas { display: flex; gap: 10px; justify-content: center; }
        .carta { width: 80px; height: 120px; background-color: white; border: 1px solid black; border-radius: 5px; position: relative; color: black; font-size: 24px; font-weight: bold; }
        .carta-jogador { cursor: pointer; transition: transform 0.2s; }
        .carta-jogador:hover { transform: translateY(-10px); }
        .carta .valor { position: absolute; top: 5px; left: 5px; }
        .carta .naipe { font-size: 40px; position: absolute; bottom: 5px; right: 5px; }
        .carta.manilha { border: 3px solid gold; }
        .carta-placeholder { width: 80px; height: 120px; background-color: rgba(0,0,0,0.2); border: 2px dashed #FFF; border-radius: 5px; }
        .carta-virada-oponente { width: 80px; height: 120px; background-color: #B71C1C; border-radius: 5px; }
        .botoes button, .login-area button, .login-area input { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin: 5px; }
        #game-area { display: none; }
        #login-area { background-color: #004d40; padding: 20px; border-radius: 10px; }
        #meu-id-display { font-size: 1.2em; background: #FFF; color: #000; padding: 5px 10px; border-radius: 5px; user-select: all; cursor: pointer; }
        #status { min-height: 25px; margin-top: 15px; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Truco P2P (sem servidor)</h1>

        <div id="login-area">
            <h3>Conexão P2P</h3>
            <button id="btn-criar">1. Criar Jogo (Ser o Host)</button>
            <div id="host-info" style="display:none; margin-top:15px;">
                <p>Envie este ID para seu amigo:</p>
                <code id="meu-id-display"></code>
            </div>
            <hr>
            <input type="text" id="input-oponente-id" placeholder="2. Cole o ID do Host aqui">
            <button id="btn-entrar">Entrar no Jogo</button>
            <div id="status">Aguardando conexão...</div>
        </div>

        <div id="game-area">
            <!-- Estrutura do jogo (placar, mesa, cartas) igual à anterior -->
            <div class="placar">
                <div>Você: <span id="placar-nos">0</span></div>
                <div>Oponente: <span id="placar-eles">0</span></div>
            </div>

            <div class="mesa">
                <div id="area-oponente" class="area-cartas"></div>
                <div id="area-vira"></div>
                <div id="area-mesa" class="area-cartas">
                    <div id="mesa-oponente" class="carta-placeholder"></div>
                    <div id="mesa-jogador" class="carta-placeholder"></div>
                </div>
            </div>

            <div id="area-jogador" class="area-cartas"></div>
            
            <div class="botoes">
                <button id="btn-truco">TRUCO!</button>
                <button id="btn-nova-mao">Nova Mão (Apenas Host)</button>
            </div>
            <div id="mensagem" style="margin-top: 15px; font-size: 1.2em; min-height: 25px;"></div>
        </div>
    </div>

    <script>
        // --- Elementos da UI ---
        const loginArea = document.getElementById('login-area');
        const gameArea = document.getElementById('game-area');
        const btnCriar = document.getElementById('btn-criar');
        const btnEntrar = document.getElementById('btn-entrar');
        const meuIdDisplay = document.getElementById('meu-id-display');
        const hostInfo = document.getElementById('host-info');
        const inputOponenteId = document.getElementById('input-oponente-id');
        const statusEl = document.getElementById('status');
        const mensagemEl = document.getElementById('mensagem');
        const areaJogadorEl = document.getElementById('area-jogador');
        // ... (outros elementos da UI do jogo)

        // --- Variáveis de Conexão e Jogo ---
        let peer;
        let conn; // A conexão de dados
        let meuId;
        let souHost = false;
        let minhaMao = [];
        let manilhaValor = '';

        function inicializarPeer() {
            // Conecta ao servidor de sinalização público do PeerJS
            peer = new Peer(); 

            // Evento disparado quando obtemos nosso ID
            peer.on('open', (id) => {
                meuId = id;
                console.log('Meu ID de peer é: ' + id);
                statusEl.textContent = 'Pronto para criar ou entrar em um jogo.';
            });

            // Evento disparado quando um cliente tenta se conectar (só para o host)
            peer.on('connection', (newConn) => {
                if (conn) { // Se já temos uma conexão, recusamos a nova
                    newConn.close();
                    return;
                }
                conn = newConn;
                souHost = true;
                iniciarConexao();
            });

            peer.on('error', (err) => {
                alert('Ocorreu um erro com a conexão P2P: ' + err.message);
                console.error(err);
            });
        }
        
        btnCriar.addEventListener('click', () => {
            if (!meuId) {
                alert('Aguardando ID de conexão, tente novamente em um segundo.');
                return;
            }
            souHost = true;
            meuIdDisplay.textContent = meuId;
            hostInfo.style.display = 'block';
            statusEl.textContent = 'Aguardando oponente se conectar...';
            btnCriar.disabled = true;
            btnEntrar.disabled = true;
            inputOponenteId.disabled = true;
        });

        btnEntrar.addEventListener('click', () => {
            const oponenteId = inputOponenteId.value.trim();
            if (!oponenteId) {
                alert('Por favor, insira o ID do Host.');
                return;
            }
            conn = peer.connect(oponenteId);
            iniciarConexao();
        });

        function iniciarConexao() {
            if (!conn) return;

            conn.on('open', () => {
                console.log('Conexão estabelecida!');
                statusEl.textContent = 'Conectado!';
                loginArea.style.display = 'none';
                gameArea.style.display = 'block';

                if (souHost) {
                    // O Host é responsável por iniciar a primeira mão
                    document.getElementById('btn-nova-mao').style.display = 'inline-block';
                    iniciarNovaMao();
                } else {
                    document.getElementById('btn-nova-mao').style.display = 'none';
                    mensagemEl.textContent = 'Conectado! Aguardando o Host iniciar a mão.';
                }
            });

            // Onde a mágica acontece: recebendo dados
            conn.on('data', (data) => {
                console.log('Dado recebido:', data);
                // Aqui vamos processar todos os tipos de mensagens
                if (data.type === 'mao') {
                    minhaMao = data.mao;
                    manilhaValor = data.gameState.manilha;
                    desenharMao(minhaMao, manilhaValor);
                    desenharVira(data.gameState.vira, manilhaValor);
                    desenharMaoOponente(minhaMao.length);
                    mensagemEl.textContent = 'Sua vez de jogar!';
                }
                if (data.type === 'cartaJogada') {
                    // Atualiza a mesa do oponente
                    const cartaEl = criarElementoCarta(data.carta, manilhaValor);
                    document.getElementById('mesa-oponente').innerHTML = '';
                    document.getElementById('mesa-oponente').appendChild(cartaEl);
                }
            });
            
            conn.on('close', () => {
                alert('O oponente desconectou.');
                gameArea.style.display = 'none';
                loginArea.style.display = 'block';
            });
        }

        // Função para enviar qualquer tipo de dado para o oponente
        function enviarDado(data) {
            if (conn && conn.open) {
                conn.send(data);
            }
        }

        // --- LÓGICA DO JOGO (Adaptada para P2P) ---

        document.getElementById('btn-nova-mao').addEventListener('click', () => {
            if(souHost) iniciarNovaMao();
        });

        function iniciarNovaMao() {
            if (!souHost) return; // Apenas o host pode iniciar uma mão

            const naipes = ['♦', '♠', '♥', '♣'];
            const valores = ['4', '5', '6', '7', 'Q', 'J', 'K', 'A', '2', '3'];
            let baralho = [];
            for (const naipe of naipes) {
                for (const valor of valores) {
                    baralho.push({ valor, naipe });
                }
            }
            // Embaralhar...
            for (let i = baralho.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [baralho[i], baralho[j]] = [baralho[j], baralho[i]];
            }

            const vira = baralho[6];
            const viraIndex = valores.indexOf(vira.valor);
            const manilha = viraIndex === valores.length - 1 ? valores[0] : valores[viraIndex + 1];

            const maoHost = baralho.slice(0, 3);
            const maoCliente = baralho.slice(3, 6);

            const gameState = { vira: vira, manilha: manilha };

            // O Host configura sua própria tela
            minhaMao = maoHost;
            manilhaValor = gameState.manilha;
            desenharMao(minhaMao, manilhaValor);
            desenharVira(gameState.vira, manilhaValor);
            desenharMaoOponente(maoCliente.length);
            mensagemEl.textContent = 'Sua vez de jogar!';

            // O Host envia a mão e o estado do jogo para o Cliente
            enviarDado({ type: 'mao', mao: maoCliente, gameState: gameState });
        }
        
        // --- Funções de Desenho (praticamente inalteradas) ---
        function criarElementoCarta(carta, manilha, isJogador = false) {
            const cartaEl = document.createElement('div');
            cartaEl.classList.add('carta');
            if (isJogador) cartaEl.classList.add('carta-jogador');
            if (carta.valor === manilha) cartaEl.classList.add('manilha');

            cartaEl.innerHTML = `<div class="valor">${carta.valor}</div><div class="naipe">${carta.naipe}</div>`;
            
            if (isJogador) {
                cartaEl.addEventListener('click', () => {
                    // Atualiza a UI localmente
                    const index = minhaMao.findIndex(c => c.valor === carta.valor && c.naipe === carta.naipe);
                    if (index > -1) {
                        minhaMao.splice(index, 1);
                        desenharMao(minhaMao, manilha);
                        document.getElementById('mesa-jogador').innerHTML = '';
                        document.getElementById('mesa-jogador').appendChild(criarElementoCarta(carta, manilha));
                    }
                    // Envia a jogada para o oponente
                    enviarDado({ type: 'cartaJogada', carta: carta });
                });
            }
            return cartaEl;
        }

        function desenharMao(mao, manilha) {
            areaJogadorEl.innerHTML = '';
            mao.forEach(carta => areaJogadorEl.appendChild(criarElementoCarta(carta, manilha, true)));
        }
        
        function desenharVira(vira, manilha) {
            document.getElementById('area-vira').innerHTML = '';
            document.getElementById('area-vira').appendChild(criarElementoCarta(vira, manilha));
        }
        
        function desenharMaoOponente(numCartas) {
            const areaOponenteEl = document.getElementById('area-oponente');
            areaOponenteEl.innerHTML = '';
            for(let i=0; i<numCartas; i++) {
                const cartaVirada = document.createElement('div');
                cartaVirada.classList.add('carta-virada-oponente');
                areaOponenteEl.appendChild(cartaVirada);
            }
        }
        
        // Inicia o processo de conexão ao carregar a página
        inicializarPeer();
    </script>
</body>
</html>
